function capitalize(e){if(e!==null&&typeof e!=="undefined"){return e.substring(0,1).toUpperCase()+e.substring(1).toLowerCase()}}function formatDistrictName(e,t){return(e.name?e.name+" ":(t?t:capitalize(e.type))+" District ")+(!(e.type&&e.type.toLowerCase()=="senate")&&!(t&&t.toLowerCase()=="senate")?e.district:"")+(e.member?" - "+e.member.name:"")+(e.senator?" - "+e.senator.name:"")}var sage=angular.module("sage",[]);var baseApi="/api/v2";var map;sage.factory("responseService",function(e){var t={};t.setResponse=function(e,t,n){this.handle=e;this.response=t;this.view=n;this.broadcastToViews();this.broadcastItem()};t.broadcastItem=function(){e.$broadcast(this.handle)};t.broadcastToViews=function(){if(this.view!=null&&typeof this.view!="undefined"){e.$broadcast("view")}};return t});sage.factory("mapService",function(e,t){var n={};n.el=$("#mapView");n.mapOptions={center:new google.maps.LatLng(42.651445,-73.755254),zoom:15,mapTypeId:google.maps.MapTypeId.ROADMAP,panControl:false,zoomControl:true,zoomControlOptions:{style:google.maps.ZoomControlStyle.LARGE,position:google.maps.ControlPosition.LEFT_TOP},styles:[{featureType:"transit",stylers:[{visibility:"off"}]}]};n.map=new google.maps.Map(document.getElementById("map_canvas"),n.mapOptions);n.polygons=[];n.polygon=null;n.markers=[];n.activeMarker=null;n.header="Map";n.districtData=null;n.resizeMap=function(){google.maps.event.trigger(n.map,"resize")};n.toggleMap=function(e){if(e){$(this.el).fadeIn("fast",function(){n.resizeMap()})}else{$(this.el).hide()}};n.setZoom=function(e){this.map.setZoom(e)};n.setCenter=function(e,t){this.map.setCenter(new google.maps.LatLng(e,t))};n.setMarker=function(e,t,r,i,s){if(i){this.clearMarkers()}var o=new google.maps.Marker({map:n.map,draggable:false,animation:google.maps.Animation.DROP,position:new google.maps.LatLng(e,t),title:r});if(s){var u=new google.maps.InfoWindow({content:s});google.maps.event.addListener(o,"click",function(){u.open(n.map,o)})}this.activeMarker=o;this.markers.push(o);this.map.setCenter(this.activeMarker.position)};n.setOverlay=function(e,t,r,i,s,o){if(e!=null){if(i==true){this.clearPolygons()}var u=[];for(var a in e){for(var f in e[a]){u.push(new google.maps.LatLng(e[a][f][0],e[a][f][1]))}var l=new google.maps.Polygon({paths:u,strokeColor:o?o:"teal",strokeOpacity:1,strokeWeight:2,fillColor:o?o:"teal",fillOpacity:.1});google.maps.event.addListener(l,"mouseover",function(){this.setOptions({fillOpacity:.4});var e=angular.element(n.el).scope();e.$apply(function(){e.header=t})});google.maps.event.addListener(l,"mouseout",function(){this.setOptions({fillOpacity:.2})});if(s){google.maps.event.addListener(l,"click",function(){if(n.polygon){n.polygon.setOptions({fillColor:"teal"});n.polygon.setOptions({fillOpacity:.2})}this.setOptions({fillColor:"orange"});this.setOptions({fillOpacity:.5});n.polygon=this;s()})}l.setMap(this.map);this.polygons.push(l);this.polygon=l;u=[]}if(r){this.map.fitBounds(this.polygon.getBounds());this.map.setZoom(this.map.getZoom()+1)}this.header=t;return this.polygon}else{this.clearPolygons()}return null};n.clearPolygon=function(e){if(e){try{e.setMap(null)}catch(t){}}};n.clearPolygons=function(){$.each(this.polygons,function(e,t){t.setMap(null)});this.polygons=[]};n.clearMarkers=function(){$.each(this.markers,function(e,t){t.setMap(null)});this.markers=[]};n.geocode=function(e){googleGeocoder.geocode({address:e},function(e,t){if(t==google.maps.GeocoderStatus.OK){return e[0].geometry.location}return null})};n.formatDistrictName=function(e){console.log(e);return(e.name?e.name+" ":capitalize(e.type)+" District ")+e.district+(e.member?" - "+e.member.name:"")+(e.senator?" - "+e.senator.name:"")};return n});sage.factory("uiBlocker",function(e){var t={};t.block=function(e){$.blockUI({css:{border:"1px solid #ddd"},overlayCSS:{backgroundColor:"#eee",opacity:.5},message:e})};t.unBlock=function(){$.unblockUI()};return t});sage.filter("remove",function(){return function(e,t){if(e!==null&&typeof e!=="undefined"){return e.replace(t,"")}}});sage.filter("capitalize",function(){return function(e){if(e!==null&&typeof e!=="undefined"){return capitalize(e)}}});sage.filter("districtName",function(){return function(e){return formatDistrictName(e,type)}});sage.filter("senatorPic",function(){return function(e){if(e){return"http://www.nysenate.gov/files/imagecache/senator_teaser/"+e.substring(30)}}});sage.filter("addressFormat",function(){return function(e){function r(e){return e!=null&&e!=""&&e!="null"}if(e!=null&&typeof e!=="undefined"){var t=(r(e.addr1)?e.addr1:"")+(r(e.addr2)?" "+e.addr2+"":"");var n=(r(e.city)?" "+e.city+",":"")+(r(e.state)?" "+e.state:"")+(r(e.zip5)?" "+e.zip5:"")+(r(e.zip4)?"-"+e.zip4:"");return((t?t+"<br>":"")+n).trim()}}});sage.directive("myTable",function(){return function(e,t,n){var r={};if(n.myTable.length>0){r=e.$eval(n.myTable)}else{r={bStateSave:true,iCookieDuration:2419200,bJQueryUI:true,bPaginate:false,bLengthChange:false,bFilter:false,bInfo:false,bDestroy:true}}var i=[];t.find("th").each(function(e,t){i.push($(t).text())});if(i.length>0){r["aoColumns"]=i}else if(n.aoColumns){r["aoColumns"]=e.$eval(n.aoColumns)}if(n.aoColumnDefs){r["aoColumnDefs"]=e.$eval(n.aoColumnDefs)}if(n.aaSorting){r["aaSorting"]=e.$eval(n.aaSorting)}if(n.fnRowCallback){r["fnRowCallback"]=e.$eval(n.fnRowCallback)}var s=t.dataTable(r);$("#street-search").keyup(function(){s.fnFilter(this.value,2)});e.$watch(n.aaData,function(t){var r=t||null;if(r){s.fnClearTable();s.fnAddData(e.$eval(n.aaData))}})}});sage.controller("DistrictInfoController",function(e,t,n,r){e.addr1="30 Tryon Pl";e.city="Albany";e.state="NY";e.zip5="";e.geoProvider="default";e.provider="default";e.lookup=function(){r.block("Looking up districts");t.get(this.getDistUrl()).success(function(e){n.setResponse("districtInfo",e,"districtView")}).error(function(e,t,n,i){r.unBlock();alert("Failed to lookup districts. The application did not return a response.")})};e.getDistUrl=function(){var e=contextPath+baseApi+"/district/assign?addr1="+this.addr1+"&city="+this.city+"&state="+(this.state?this.state:"NY")+"&zip5="+this.zip5;e+=this.provider!=""&&this.provider!="default"?"&provider="+this.provider:"";e+=this.geoProvider!=""&&this.geoProvider!="default"?"&geoProvider="+this.geoProvider:"";e+="&showMembers=true&showMaps=true";e=e.replace(/#/g,"");return e}});sage.controller("DistrictMapController",function(e,t,n,r){e.type="senate";e.district="";e.lookup=function(){r.block("Loading "+this.type+" maps..");t.get(this.getDistrictMapUrl()).success(function(e){n.setResponse("districtMap",e)}).error(function(e){r.unBlock();alert("Failed to retrieve district maps.")})};e.getDistrictMapUrl=function(){return contextPath+baseApi+"/map/"+this.type+"?showMembers=true"+(this.district?"&district="+this.district:"")}});sage.controller("CityStateController",function(e,t,n){e.zip5="";e.lookup=function(){t.get(this.getCityStateUrl()).success(function(e,t,r,i){n.setResponse("citystate",e,"citystate")})};e.getCityStateUrl=function(){return contextPath+baseApi+"/address/citystate?provider=mapquest&zip5="+this.zip5}});sage.controller("StreetLookupController",function(e,t,n){e.zip5="";e.lookup=function(){t.get(this.getStreetLookupUrl()).success(function(e){n.setResponse("street",e,"street")})};e.getStreetLookupUrl=function(){return contextPath+baseApi+"/street/lookup?zip5="+this.zip5}});sage.controller("RevGeoController",function(e,t,n){e.lat="";e.lon="";e.lookup=function(){t.get(this.getRevGeoUrl()).success(function(e,t,r,i){n.setResponse("revgeo",e,"revgeo")})};e.getRevGeoUrl=function(){return contextPath+baseApi+"/geo/revgeocode?lat="+this.lat+"&lon="+this.lon}});sage.controller("EmbeddedMapController",function(e,t,n,r,i){e.districtType=n.districtType;e.districtCode=n.districtCode;e.lookup=function(){if(this.districtType){i.block("Loading maps..");t.get(this.getDistrictMapUrl()).success(function(e){r.setResponse("embeddedMap",e)}).error(function(e){})}};e.getDistrictMapUrl=function(){return contextPath+baseApi+"/map/"+this.districtType+"?showMembers=true"+(this.districtCode?"&district="+this.districtCode:"")};e.lookup()});sage.controller("ResultsViewController",function(e,t,n){e.paneVisible=false;e.centercolumn=$("#contentcolumn");e.rightcolumn=$("#rightcolumn");e.width="360px";e.$on("expandResults",function(){e.paneVisible=e.toggleResultPane(t.response)});e.toggleResultPane=function(t){if(t!=null){if(t){e.centercolumn.css("marginRight",e.width);e.rightcolumn.show();n.resizeMap();return true}else{e.centercolumn.css("marginRight",0);e.rightcolumn.hide();n.resizeMap()}}return false}});sage.controller("DistrictsViewController",function(e,t,n,r,i){e.visible=false;e.viewId="districtView";e.showOffices=false;e.showNeighbors=false;e.neighborPolygons=[];e.neighborColors=["#FF4500","#639A00"];e.$on("view",function(){e.visible=e.viewId==n.view});e.$on("districtInfo",function(){e=angular.extend(e,n.response);n.setResponse("expandResults",true);r.toggleMap(true);if(e.districtAssigned){r.setOverlay(e.districts.senate.map.geom,formatDistrictName(e.districts.senate,"Senate"),true,true,null)}if(e.geocoded){r.setMarker(e.geocode.lat,e.geocode.lon,e.address.addr1!=null?e.address.addr1:"",true,null)}e.showNeighbors=false;i.unBlock();r.resizeMap()});e.$on("districtMap",function(){var e=n.response;if(e.statusCode==0){r.clearMarkers();if(e!=null&&e.districts!=null){r.clearPolygons();$.each(e.districts,function(e,t){if(t.map!=null){r.setOverlay(t.map.geom,formatDistrictName(t),false,false,t.type=="SENATE"?function(){n.setResponse("member",t.member,"member")}:null)}})}else if(e.map!=null){r.setOverlay(e.map.geom,formatDistrictName(e),true,true,e.type=="SENATE"?function(){n.setResponse("member",e.member,"member")}:null)}}r.toggleMap(true);i.unBlock()});e.showDistrict=function(t){if(e.districts[t]!=null&&typeof e.districts[t]!="undefined"){var n=e.districts[t];n.type=t;r.resizeMap();r.setOverlay(n.map.geom,formatDistrictName(n),true,true,null)}};e.showNeighborDistricts=function(t,n){this.showNeighbors=true;$.each(n,function(t,n){n.style={color:e.neighborColors[t%2]};e.neighborPolygons.push(r.setOverlay(n.map.geom,formatDistrictName(n,"Senate"),false,false,null,n.style["color"]))})};e.hideNeighborDistricts=function(){this.showNeighbors=false;$.each(e.neighborPolygons,function(e,t){r.clearPolygon(t)})};e.setOfficeMarker=function(e){if(e!=null){r.setMarker(e.latitude,e.longitude,e.name,false,null)}}});sage.controller("CityStateView",function(e,t,n){e.visible=false;e.viewId="citystate";e.$on("view",function(){e.visible=e.viewId==t.view});e.$on("citystate",function(){e=angular.extend(e,t.response);t.setResponse("expandResults",true)})});sage.controller("StreetViewController",function(e,t,n){e.visible=false;e.viewId="street";e.streets=[];e.columnDefs=[{mDataProp:"bldgLoNum",aTargets:[0]},{mDataProp:"bldgHiNum",aTargets:[1]},{mDataProp:"street",aTargets:[2]},{mDataProp:"location",aTargets:[3]},{mDataProp:"zip5",aTargets:[4]},{mDataProp:"senate",aTargets:[5]},{mDataProp:"congressional",aTargets:[6]},{mDataProp:"assembly",aTargets:[7]},{mDataProp:"county",aTargets:[8]},{mDataProp:"town",aTargets:[9]},{mDataProp:"election",aTargets:[10]}];e.overrideOptions={bStateSave:false,iCookieDuration:2419200,bJQueryUI:false,bPaginate:true,bLengthChange:false,bFilter:true,bInfo:true,bDestroy:true,iDisplayLength:20};e.sortDefault=[[2,"asc"]];e.$on("street",function(){e.streets=t.response.streets;t.setResponse("expandResults",false);n.toggleMap(false)});e.$on("view",function(){e.visible=e.viewId==t.view})});sage.controller("MemberViewController",function(e,t,n){e.visible=false;e.viewId="member";e.member;e.$on("view",function(){e.visible=e.viewId==t.view});e.$on("member",function(){e.$apply(function(){e.member=t.response;t.setResponse("expandResults",true)})});e.setOfficeMarker=function(e){if(e!=null){n.setMarker(e.latitude,e.longitude,e.name,false,null)}}});sage.controller("RevGeoViewController",function(e,t,n){e.visible=false;e.viewId="revgeo";e.revGeocoded=false;e.$on("revgeo",function(){e=angular.extend(e,t.response);e.revGeocoded=e.statusCode==0;if(e.revGeocoded){n.setMarker(e.geocode.lat,e.geocode.lon)}t.setResponse("expandResults",true);n.toggleMap(true)});e.$on("view",function(){e.visible=e.viewId==t.view})});sage.controller("EmbeddedMapViewController",function(e,t,n,r){e.showPrompt=false;e.viewInfo=false;e.$on("embeddedMap",function(){var i=t.response;if(i.statusCode==0){r.clearMarkers();if(i!=null&&i.districts!=null){r.clearPolygons();$.each(i.districts,function(e,n){if(n.map!=null){r.setOverlay(n.map.geom,formatDistrictName(n),false,false,n.type.toLowerCase()=="senate"?function(){t.setResponse("showEmbedSenator",n)}:null)}});r.setCenter(42.44051,-76.49546);r.setZoom(7)}else if(i.map!=null){e.senator=i.member;e.district=i.district;r.setOverlay(i.map.geom,formatDistrictName(i),true,true,null,null);if(i.type.toLowerCase()=="senate"){$.each(i.member.offices,function(e,t){if(t){r.setMarker(t.latitude,t.longitude,"Senate",false,"<div>"+"<p style='color:teal;font-size:18px;'>"+t.name+"</p>"+"<p>"+t.street+"</p>"+"<p>"+t.additional+"</p>"+"<p>"+t.city+", "+t.province+" "+t.postalCode+"</p>"+"<p>Phone "+t.phone+"</p>"+"</div>")}});e.showPrompt=true;e.showInfo=true}}}r.toggleMap(true);n.unBlock()});e.$on("showEmbedSenator",function(){var n=t.response;if(n){e.$apply(function(){e.showPrompt=true;e.showInfo=true;e.senator=n.member;e.district=n.district});r.clearMarkers();$.each(n.member.offices,function(e,t){if(t){r.setMarker(t.latitude,t.longitude,t.name,false,"<div>"+"<p style='color:teal;font-size:18px;'>"+t.name+"</p>"+"<p>"+t.street+"</p>"+"<p>"+t.additional+"</p>"+"<p>"+t.city+", "+t.province+" "+t.postalCode+"</p>"+"<p>Phone "+t.phone+"</p>"+"</div>")}})}})});$(document).ready(function(){initVerticalMenu();google.maps.Polygon.prototype.getBounds=function(){var e=new google.maps.LatLngBounds;var t=this.getPaths();var n;for(var r=0;r<t.getLength();r++){n=t.getAt(r);for(var i=0;i<n.getLength();i++){e.extend(n.getAt(i))}}return e}})